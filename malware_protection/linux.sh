#!/bin/bash

# Get hostname
HOSTNAME=$(hostname)

# Get current date
DATE=$(date +"%Y-%m-%d %H:%M:%S")

# Define report file (stored in the working directory)
REPORT_FILE="$(pwd)/Linux_malware_report.csv"

# Start CSV file with headers
echo "Hostname,Software,Installed,Running,Last Update" > "$REPORT_FILE"

# Function to check if a service is running
check_service() {
    SERVICE_NAME=$1
    if systemctl is-active --quiet "$SERVICE_NAME"; then
        echo "Running"
    else
        echo "Not Running"
    fi
}

# Function to check last update time of signature files
get_last_update() {
    FILE_PATH=$1
    if [[ -f "$FILE_PATH" ]]; then
        stat -c %y "$FILE_PATH" | cut -d' ' -f1
    else
        echo "Unknown"
    fi
}

# List of known malware protection software and their signature update locations
declare -A MALWARE_SOFTWARE
MALWARE_SOFTWARE["clamav"]="clamav-daemon:/var/lib/clamav/daily.cvd"
MALWARE_SOFTWARE["sophos"]="sav-protect:/opt/sophos-av/update_cache"
MALWARE_SOFTWARE["mcafee"]="ma:/opt/McAfee/agent/update.dat"
MALWARE_SOFTWARE["f-secure"]="fsavd:/var/opt/f-secure/fssp/update"
MALWARE_SOFTWARE["bitdefender"]="bdscan:/opt/BitDefender-scanner/var/lib/"

# Check for installed malware protection software
for SOFTWARE in "${!MALWARE_SOFTWARE[@]}"; do
    SERVICE_NAME=${MALWARE_SOFTWARE[$SOFTWARE]%:*}
    UPDATE_PATH=${MALWARE_SOFTWARE[$SOFTWARE]#*:}

    if command -v "$SOFTWARE" &>/dev/null || systemctl list-units --type=service | grep -q "$SERVICE_NAME"; then
        RUNNING_STATUS=$(check_service "$SERVICE_NAME")
        LAST_UPDATE=$(get_last_update "$UPDATE_PATH")
        echo "$HOSTNAME,$SOFTWARE,Yes,$RUNNING_STATUS,$LAST_UPDATE" >> "$REPORT_FILE"
    else
        echo "$HOSTNAME,$SOFTWARE,No,Not Installed,Unknown" >> "$REPORT_FILE"
    fi
done

# Check for other unknown antivirus software using running processes
OTHER_AV=$(ps aux | grep -Ei 'clam|sophos|mcafee|bitdefender|f-secure|avast|trendmicro|eset' | grep -v grep | awk '{print $11}' | sort -u)

if [[ -n "$OTHER_AV" ]]; then
    for AV in $OTHER_AV; do
        echo "$HOSTNAME,$AV,Yes,Running,Unknown" >> "$REPORT_FILE"
    done
fi

# Notify user
echo "Malware protection check completed. Report saved as: $REPORT_FILE"
