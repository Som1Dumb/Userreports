# Get current hostname
$hostname = $env:COMPUTERNAME

# Get current date
$date = Get-Date -Format "yyyy-MM-dd HH:mm:ss"

# Define report file (stored in the working directory)
$reportFile = "$PWD\malware_report_${hostname}_$(Get-Date -Format 'yyyyMMdd').csv"

# Start CSV file with headers
"Hostname,Software,Installed,Running,Last Update,Version,Up-to-Date" | Out-File -Encoding utf8 $reportFile

# Function to get installed antivirus software using Windows Security Center
function Get-InstalledAVSoftware {
    $avProducts = Get-CimInstance -Namespace "root/SecurityCenter2" -ClassName "AntivirusProduct" 2>$null
    return $avProducts
}

# Get installed antivirus software
$installedAVs = Get-InstalledAVSoftware

if ($installedAVs) {
    foreach ($av in $installedAVs) {
        $softwareName = $av.displayName
        $runningStatus = if ($av.productState -match '.*00$') { "Running" } else { "Not Running" }
        
        # Extract last update time if available
        $lastUpdate = "Unknown"
        if ($av.timestamp) {
            $lastUpdate = [System.Management.ManagementDateTimeConverter]::ToDateTime($av.timestamp).ToString("yyyy-MM-dd")
        }

        # Add entry to CSV
        "$hostname,$softwareName,Yes,$runningStatus,$lastUpdate,N/A,N/A" | Out-File -Encoding utf8 -Append $reportFile
    }
}

# Check for Windows Defender explicitly
$defenderStatus = Get-MpComputerStatus 2>$null
if ($defenderStatus) {
    $softwareName = "Windows Defender"
    $runningStatus = if ($defenderStatus.RealTimeProtectionEnabled) { "Running" } else { "Not Running" }
    
    # Get last update date
    $lastUpdate = if ($defenderStatus.AntivirusSignatureLastUpdated) { 
        ($defenderStatus.AntivirusSignatureLastUpdated).ToString("yyyy-MM-dd") 
    } else { 
        "Unknown" 
    }

    # Get version
    $version = if ($defenderStatus.AntivirusSignatureVersion) { 
        $defenderStatus.AntivirusSignatureVersion 
    } else { 
        "Unknown" 
    }

    # Check if up-to-date (last update within the last 2 days)
    $lastUpdateDate = [datetime]::ParseExact($lastUpdate, "yyyy-MM-dd", $null) 2>$null
    $currentDate = Get-Date
    $uptodateStatus = if ($lastUpdateDate -and ($currentDate - $lastUpdateDate).Days -le 2) { "Yes" } else { "No" }

    # Add entry to CSV
    "$hostname,$softwareName,Yes,$runningStatus,$lastUpdate,$version,$uptodateStatus" | Out-File -Encoding utf8 -Append $reportFile
}

# If no AV software was found
if (-not $installedAVs -and -not $defenderStatus) {
    "$hostname,None Detected,No,Not Installed,Unknown,N/A,N/A" | Out-File -Encoding utf8 -Append $reportFile
}

Write-Host "Malware protection check completed. Report saved as: $reportFile"
