SET PAGESIZE 50000
SET LINESIZE 200
SET TRIMOUT ON
SET TRIMSPOOL ON
SET HEADING OFF
SET FEEDBACK OFF

-- Define the output filename with hostname and date
COL HOSTNAME NEW_VALUE HOSTNAME
COL FILENAME NEW_VALUE FILENAME
SELECT UPPER(SYS_CONTEXT('USERENV', 'HOST')) AS HOSTNAME FROM DUAL;
SELECT 'Linux_OracleDB_User_Info_' || UPPER(SYS_CONTEXT('USERENV', 'HOST')) || '_' || TO_CHAR(SYSDATE, 'YYYYMMDD_HH24MISS') || '.csv' AS FILENAME FROM DUAL;

SPOOL &FILENAME

-- Print CSV header
echo 'USERNAME,SID,LAST_LOGIN,PRIVILEGES,USER_GROUPS,LAST_PASSWORD_CHANGE'

-- Query to collect user info, including domain users
SELECT 
    U.USERNAME || ',' ||
    NVL(S.SID, 'N/A') || ',' ||
    NVL(TO_CHAR(U.LAST_LOGIN, 'YYYY-MM-DD HH24:MI:SS'), 'N/A') || ',' ||
    NVL((SELECT LISTAGG(GRANTED_ROLE, '; ') WITHIN GROUP (ORDER BY GRANTED_ROLE) FROM DBA_ROLE_PRIVS WHERE GRANTEE = U.USERNAME), 'NONE') || ',' ||
    NVL((SELECT LISTAGG(GRANTED_ROLE, '; ') WITHIN GROUP (ORDER BY GRANTED_ROLE) FROM DBA_ROLE_PRIVS WHERE GRANTEE = U.USERNAME), 'NONE') || ',' ||
    NVL(TO_CHAR(P.PASSWORD_DATE, 'YYYY-MM-DD HH24:MI:SS'), 'N/A')
FROM DBA_USERS U
LEFT JOIN V$SESSION S ON U.USERNAME = S.USERNAME
LEFT JOIN DBA_USERS P ON U.USER_ID = P.USER_ID
UNION ALL
SELECT 
    DU.USERNAME || ',' ||
    'DOMAIN_USER' || ',' ||
    'N/A' || ',' ||
    NVL((SELECT LISTAGG(GRANTED_ROLE, '; ') WITHIN GROUP (ORDER BY GRANTED_ROLE) FROM DBA_ROLE_PRIVS WHERE GRANTEE = DU.USERNAME), 'NONE') || ',' ||
    NVL((SELECT LISTAGG(GRANTED_ROLE, '; ') WITHIN GROUP (ORDER BY GRANTED_ROLE) FROM DBA_ROLE_PRIVS WHERE GRANTEE = DU.USERNAME), 'NONE') || ',' ||
    NVL(TO_CHAR(DU.EXPIRY_DATE, 'YYYY-MM-DD HH24:MI:SS'), 'N/A')
FROM DBA_USERS DU WHERE DU.USERNAME LIKE '%\%'; -- To identify domain users

SPOOL OFF

-- Re-enable heading
SET HEADING ON
SET FEEDBACK ON
